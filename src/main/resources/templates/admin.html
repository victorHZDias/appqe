<!DOCTYPE html>
<!-- Adicionado o namespace do Thymeleaf Security -->
<html lang="en" xmlns:th="http://www.thymeleaf.org" xmlns:sec="http://www.thymeleaf.org/extras/spring-security">
<head>
    <meta charset="UTF-8">
    <title>Painel de Administração</title>
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet"
          xintegrity="sha384-QWTKZyjpPEjISv5WaRU9OFeRpok6YctnYmDr5pNlyT2bRjXh0JMhjY6hW+ALEwIH" crossorigin="anonymous">
    <script>
        // Script para aplicar o tema imediatamente e evitar "flash" de conteúdo
        (() => {
            const storedTheme = localStorage.getItem('theme');
            const prefersDark = window.matchMedia('(prefers-color-scheme: dark)').matches;
            const theme = storedTheme || (prefersDark ? 'dark' : 'light');
            document.documentElement.setAttribute('data-bs-theme', theme);
        })();
    </script>
</head>
<body>

<nav class="navbar navbar-expand-lg navbar-dark bg-dark">
    <div class="container-fluid">
        <a class="navbar-brand" href="/">Minha Aplicação</a>
        <div class="d-flex align-items-center">
            <a sec:authorize="hasAnyAuthority('ADMIN', 'SUPERADMIN')" class="btn btn-primary me-2" href="/admin">Painel Admin</a>
            <a class="btn btn-info me-2" href="/api-docs">Documentação da API</a>
            <a class="btn btn-secondary me-2" href="/">Início</a>
            <form th:action="@{/logout}" method="post" class="d-inline">
                <button type="submit" class="btn btn-danger">Sair</button>
            </form>
            <!-- Botão de Troca de Tema -->
            <button id="theme-toggle" type="button" class="btn btn-outline-light ms-2">
                <!-- Ícones de Sol/Lua -->
                <svg id="theme-toggle-sun-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-sun-fill d-none" viewBox="0 0 16 16"><path d="M8 12a4 4 0 1 0 0-8 4 4 0 0 0 0 8M8 0a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 0m0 13a.5.5 0 0 1 .5.5v2a.5.5 0 0 1-1 0v-2A.5.5 0 0 1 8 13m8-5a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2a.5.5 0 0 1 .5.5M3 8a.5.5 0 0 1-.5.5h-2a.5.5 0 0 1 0-1h2A.5.5 0 0 1 3 8m10.657-5.657a.5.5 0 0 1 0 .707l-1.414 1.415a.5.5 0 1 1-.707-.708l1.414-1.414a.5.5 0 0 1 .707 0m-9.193 9.193a.5.5 0 0 1 0 .707L3.05 13.657a.5.5 0 0 1-.707-.707l1.414-1.414a.5.5 0 0 1 .707 0m9.193 2.121a.5.5 0 0 1-.707 0l-1.414-1.414a.5.5 0 0 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .707M4.464 4.465a.5.5 0 0 1-.707 0L2.343 3.05a.5.5 0 1 1 .707-.707l1.414 1.414a.5.5 0 0 1 0 .708"/></svg>
                <svg id="theme-toggle-moon-icon" xmlns="http://www.w3.org/2000/svg" width="16" height="16" fill="currentColor" class="bi bi-moon-fill d-none" viewBox="0 0 16 16"><path d="M6 .278a.77.77 0 0 1 .08.858 7.2 7.2 0 0 0-.878 3.46c0 4.021 3.278 7.277 7.318 7.277q.792-.001 1.533-.16a.79.79 0 0 1 .81.316.73.73 0 0 1-.031.893A8.35 8.35 0 0 1 8.344 16C3.734 16 0 12.286 0 7.71 0 4.266 2.114 1.312 5.124.06A.75.75 0 0 1 6 .278"/></svg>
            </button>
        </div>
    </div>
</nav>

<div class="container mt-5">
    <h1 class="mb-4">Painel de Administração</h1>

    <!-- SEÇÃO DE USUÁRIOS DO SISTEMA (Fora do Accordion) -->
    <div class="card mb-4" sec:authorize="hasAuthority('SUPERADMIN')">
        <div class="card-header">
            <h3>Gerenciamento de Usuários do Sistema</h3>
        </div>
        <div class="card-body">
            <h4 class="mb-3">Adicionar Novo Usuário</h4>
            <form th:action="@{/admin/add-system-user}" method="post" class="mb-5">
                <div class="row g-3 align-items-end">
                    <div class="col-md">
                        <label for="systemUsername" class="form-label">Username</label>
                        <input type="text" class="form-control" id="systemUsername" name="username" required>
                    </div>
                    <div class="col-md">
                        <label for="systemPassword" class="form-label">Senha</label>
                        <input type="password" class="form-control" id="systemPassword" name="password" required>
                    </div>
                    <div class="col-md">
                        <label for="systemRole" class="form-label">Role</label>
                        <select class="form-select" id="systemRole" name="role" required>
                            <option value="SUPERADMIN">SUPERADMIN</option>
                            <option value="ADMIN">ADMIN</option>
                            <option value="USER">USER</option>
                        </select>
                    </div>
                    <div class="col-md-auto">
                        <button type="submit" class="btn btn-success w-100">Adicionar</button>
                    </div>
                </div>
            </form>

            <h4 class="mb-3">Usuários Cadastrados</h4>
            <table class="table table-striped table-hover">
                <thead>
                <tr>
                    <th>ID</th>
                    <th>Username</th>
                    <th>Role</th>
                    <th>Ações</th>
                </tr>
                </thead>
                <tbody>
                <tr th:each="user : ${systemUsers}">
                    <td th:text="${user.id}">1</td>
                    <td th:text="${user.username}">admin</td>
                    <td th:text="${user.role}">SUPERADMIN</td>
                    <td>
                        <a th:href="@{/admin/edit-system-user/{id}(id=${user.id})}" class="btn btn-sm btn-warning">Editar</a>
                        <form th:action="@{/admin/delete-system-user/{id}(id=${user.id})}" method="post" class="d-inline ms-1">
                            <button type="submit" class="btn btn-sm btn-danger" onclick="return confirm('Tem certeza que deseja excluir este usuário?');">Excluir</button>
                        </form>
                    </td>
                </tr>
                </tbody>
            </table>
        </div>
    </div>

    <!-- ACCORDION PARA OUTRAS SEÇÕES DE GERENCIAMENTO -->
    <div class="accordion" id="managementAccordion">

        <!-- Item 1: Credenciais -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingCredentials">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseCredentials" aria-expanded="false" aria-controls="collapseCredentials">
                    Gerenciamento de Credenciais
                </button>
            </h2>
            <div id="collapseCredentials" class="accordion-collapse collapse" aria-labelledby="headingCredentials" data-bs-parent="#managementAccordion">
                <div class="accordion-body">
                    <div class="card mb-4">
                        <div class="card-header"><h5>Adicionar Nova Credencial</h5></div>
                        <div class="card-body">
                            <form id="add-credential-form">
                                <div class="mb-3">
                                    <label for="new-credential-key" class="form-label">Nome da Chave (Ex: assemblyai_api_key)</label>
                                    <input type="text" class="form-control" id="new-credential-key" required>
                                </div>
                                <div class="mb-3">
                                    <label for="new-credential-value" class="form-label">Valor da Chave</label>
                                    <input type="text" class="form-control" id="new-credential-value" required>
                                </div>
                                <button type="submit" class="btn btn-success">Adicionar Credencial</button>
                            </form>
                            <div id="add-credential-feedback" class="mt-3"></div>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h5>Credenciais Existentes</h5></div>
                        <div class="card-body">
                            <form id="credentials-form">
                                <div th:if="${#lists.isEmpty(credentials)}"><p class="text-muted">Nenhuma credencial cadastrada.</p></div>
                                <div th:each="cred : ${credentials}" class="mb-3">
                                    <label th:for="${cred.key}" class="form-label" th:text="${cred.key}"></label>
                                    <input type="text" class="form-control" th:id="${cred.key}" th:name="${cred.key}" th:value="${cred.value}">
                                </div>
                                <button type="submit" class="btn btn-primary" th:if="${not #lists.isEmpty(credentials)}">Salvar Alterações</button>
                            </form>
                            <div id="credentials-feedback" class="mt-3"></div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Item 2: Planos -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingPlans">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapsePlans" aria-expanded="false" aria-controls="collapsePlans">
                    Gerenciamento de Planos
                </button>
            </h2>
            <div id="collapsePlans" class="accordion-collapse collapse" aria-labelledby="headingPlans" data-bs-parent="#managementAccordion">
                <div class="accordion-body">
                    <div class="card mb-4">
                        <div class="card-header"><h5>Adicionar Novo Plano</h5></div>
                        <div class="card-body">
                            <form th:action="@{/admin/add-plan}" method="post">
                                <div class="mb-3">
                                    <label for="planName" class="form-label">Nome do Plano:</label>
                                    <input type="text" class="form-control" id="planName" name="name" required>
                                </div>
                                <div class="mb-3">
                                    <label for="planMinutes" class="form-label">Minutos:</label>
                                    <input type="number" class="form-control" id="planMinutes" name="minutes" required>
                                </div>
                                <div class="mb-3">
                                    <label for="planPrice" class="form-label">Preço:</label>
                                    <input type="number" class="form-control" id="planPrice" name="price" step="0.01" required>
                                </div>
                                <div class="mb-3">
                                    <label class="form-label">Serviços Inclusos:</label>
                                    <div th:each="service : ${services}" class="form-check">
                                        <input class="form-check-input" type="checkbox" th:id="${'service-' + service.id}" th:value="${service.id}" name="services">
                                        <label class="form-check-label" th:for="${'service-' + service.id}" th:text="${service.description}"></label>
                                    </div>
                                </div>
                                <button type="submit" class="btn btn-success">Adicionar Plano</button>
                            </form>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h5>Planos Disponíveis</h5></div>
                        <div class="card-body">
                            <table class="table table-striped table-hover">
                                <thead>
                                <tr>
                                    <th>ID</th><th>Nome</th><th>Minutos</th><th>Preço</th><th>Serviços</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="plan : ${plans}">
                                    <td th:text="${plan.id}">1</td>
                                    <td th:text="${plan.name}">Plano Básico</td>
                                    <td th:text="${plan.minutes}">60</td>
                                    <td th:text="${plan.price}">20.00</td>
                                    <td>
                                        <ul><li th:each="service : ${plan.services}" th:text="${service.description}"></li></ul>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- Item 3: Serviços -->
        <div class="accordion-item">
            <h2 class="accordion-header" id="headingServices">
                <button class="accordion-button collapsed" type="button" data-bs-toggle="collapse" data-bs-target="#collapseServices" aria-expanded="false" aria-controls="collapseServices">
                    Gerenciamento de Serviços
                </button>
            </h2>
            <div id="collapseServices" class="accordion-collapse collapse" aria-labelledby="headingServices" data-bs-parent="#managementAccordion">
                <div class="accordion-body">
                    <div class="card mb-4">
                        <div class="card-header"><h5>Adicionar Novo Serviço</h5></div>
                        <div class="card-body">
                            <form th:action="@{/admin/add-service}" method="post">
                                <div class="mb-3">
                                    <label for="serviceDescription" class="form-label">Descrição do serviço:</label>
                                    <input type="text" class="form-control" id="serviceDescription" name="description" required>
                                </div>
                                <div class="mb-3">
                                    <label for="costPerMinute" class="form-label">Custo por Minuto:</label>
                                    <input type="number" class="form-control" id="costPerMinute" name="costPerMinute" step="0.01" required>
                                </div>
                                <button type="submit" class="btn btn-success">Adicionar Serviço</button>
                            </form>
                        </div>
                    </div>
                    <div class="card">
                        <div class="card-header"><h5>Serviços Disponíveis</h5></div>
                        <div class="card-body">
                            <table class="table table-striped table-hover">
                                <thead>
                                <tr>
                                    <th>ID</th><th>Descrição</th><th>Custo por Minuto</th><th>Ações</th>
                                </tr>
                                </thead>
                                <tbody>
                                <tr th:each="service : ${services}">
                                    <td th:text="${service.id}">1</td>
                                    <td th:text="${service.description}">Audio Transcript</td>
                                    <td th:text="${service.costPerMinute}">3.00</td>
                                    <td>
                                        <form th:action="@{/admin/delete-service/{id}(id=${service.id})}" method="post" class="d-inline">
                                            <button type="submit" class="btn btn-sm btn-danger">Deletar</button>
                                        </form>
                                    </td>
                                </tr>
                                </tbody>
                            </table>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
<script>
    // Lógica para o botão de troca de tema
    const themeToggleBtn = document.getElementById('theme-toggle');
    const sunIcon = document.getElementById('theme-toggle-sun-icon');
    const moonIcon = document.getElementById('theme-toggle-moon-icon');
    const htmlElement = document.documentElement;

    function applyTheme(theme) {
        htmlElement.setAttribute('data-bs-theme', theme);
        if (theme === 'dark') {
            sunIcon.classList.remove('d-none');
            moonIcon.classList.add('d-none');
        } else {
            moonIcon.classList.remove('d-none');
            sunIcon.classList.add('d-none');
        }
    }

    themeToggleBtn.addEventListener('click', () => {
        const currentTheme = htmlElement.getAttribute('data-bs-theme');
        const newTheme = currentTheme === 'dark' ? 'light' : 'dark';
        localStorage.setItem('theme', newTheme);
        applyTheme(newTheme);
    });

    // Aplica o tema correto e o ícone ao carregar a página
    document.addEventListener('DOMContentLoaded', () => {
        applyTheme(htmlElement.getAttribute('data-bs-theme'));
    });
</script>
</body>
</html>
